# é¡¹ç›®æ¶æ„è¯´æ˜

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®¢æˆ·ç«¯å±‚                             â”‚
â”‚                  (Postman/å‰ç«¯åº”ç”¨/Knife4j)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Controllerå±‚                           â”‚
â”‚  - AuthController (è®¤è¯)                                     â”‚
â”‚  - SysUserController (ç”¨æˆ·ç®¡ç†)                              â”‚
â”‚  - SysRoleController (è§’è‰²ç®¡ç†)                              â”‚
â”‚  - SysMenuController (èœå•ç®¡ç†)                              â”‚
â”‚  - SysDeptController (éƒ¨é—¨ç®¡ç†)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Securityè¿‡æ»¤å™¨é“¾                           â”‚
â”‚  JwtAuthenticationFilter â†’ éªŒè¯Token â†’ è®¾ç½®ç”¨æˆ·ä¿¡æ¯           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Serviceå±‚                            â”‚
â”‚  - IAuthService (ç™»å½•æœåŠ¡)                                   â”‚
â”‚  - ISysUserService (ç”¨æˆ·æœåŠ¡)                                â”‚
â”‚  - ISysRoleService (è§’è‰²æœåŠ¡)                                â”‚
â”‚  - ISysMenuService (èœå•æœåŠ¡)                                â”‚
â”‚  - ISysDeptService (éƒ¨é—¨æœåŠ¡)                                â”‚
â”‚  - UserDetailsService (Spring Securityè®¤è¯)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Mapperå±‚                              â”‚
â”‚  MyBatis Plus BaseMapper â†’ ç®€åŒ–CRUDæ“ä½œ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MyBatis Plusæ‹¦æˆªå™¨                         â”‚
â”‚  - DataScopeInterceptor (æ•°æ®æƒé™è¿‡æ»¤)                        â”‚
â”‚  - PaginationInnerInterceptor (åˆ†é¡µ)                         â”‚
â”‚  - OptimisticLockerInnerInterceptor (ä¹è§‚é”)                 â”‚
â”‚  - BlockAttackInnerInterceptor (é˜²å…¨è¡¨æ“ä½œ)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å­˜å‚¨å±‚                              â”‚
â”‚            MySQL (ä¸šåŠ¡æ•°æ®)  +  Redis (ä¼šè¯ç¼“å­˜)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” è®¤è¯æµç¨‹

```
1. ç”¨æˆ·ç™»å½•
   â†“
2. AuthController.login() æ¥æ”¶è¯·æ±‚
   â†“
3. AuthenticationManager éªŒè¯ç”¨æˆ·åå¯†ç 
   â†“
4. UserDetailsService.loadUserByUsername() æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
   â†“
5. éªŒè¯æˆåŠŸ,ç”ŸæˆJWT Token
   â†“
6. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥Redis (key: login:user:{username})
   â†“
7. è¿”å›Tokenç»™å®¢æˆ·ç«¯

åç»­è¯·æ±‚:
1. å®¢æˆ·ç«¯æºå¸¦Tokenè®¿é—®æ¥å£
   â†“
2. JwtAuthenticationFilter æ‹¦æˆªè¯·æ±‚
   â†“
3. éªŒè¯Tokenæœ‰æ•ˆæ€§
   â†“
4. ä»Redisè·å–ç”¨æˆ·ä¿¡æ¯
   â†“
5. è®¾ç½®Securityä¸Šä¸‹æ–‡
   â†“
6. ç»§ç»­å¤„ç†è¯·æ±‚
```

## ğŸ›¡ï¸ æƒé™æ§åˆ¶æµç¨‹

### æ¥å£æƒé™æ§åˆ¶
```
1. è¯·æ±‚åˆ°è¾¾Controlleræ–¹æ³•
   â†“
2. @PreAuthorize("hasAuthority('system:user:list')") æ‹¦æˆª
   â†“
3. Spring Securityæ£€æŸ¥å½“å‰ç”¨æˆ·æƒé™
   â†“
4. ä»LoginUserä¸­è·å–permissionsé›†åˆ
   â†“
5. åˆ¤æ–­æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
   â†“
6. æœ‰æƒé™ â†’ ç»§ç»­æ‰§è¡Œ / æ— æƒé™ â†’ æŠ›å‡ºAccessDeniedException
```

### æ•°æ®æƒé™æ§åˆ¶
```
1. è¯·æ±‚åˆ°è¾¾Controlleræ–¹æ³•
   â†“
2. @DataScope(deptAlias = "d", userAlias = "u") æ ‡è®°
   â†“
3. Serviceå±‚æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
   â†“
4. DataScopeInterceptor æ‹¦æˆªSQL
   â†“
5. è·å–å½“å‰ç”¨æˆ·çš„dataScope (1-5)
   â†“
6. æ ¹æ®dataScopeåŠ¨æ€ä¿®æ”¹SQL:
   - 1: ä¸è¿‡æ»¤(å…¨éƒ¨æ•°æ®)
   - 2: æ·»åŠ è‡ªå®šéƒ¨é—¨è¿‡æ»¤
   - 3: æ·»åŠ æœ¬éƒ¨é—¨è¿‡æ»¤ (dept_id = ?)
   - 4: æ·»åŠ æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨è¿‡æ»¤
   - 5: æ·»åŠ æœ¬äººè¿‡æ»¤ (user_id = ?)
   â†“
7. æ‰§è¡Œä¿®æ”¹åçš„SQL,è¿”å›è¿‡æ»¤åçš„æ•°æ®
```

## ğŸ“¦ åŒ…ç»“æ„è¯´æ˜

```
com.example.rbac/
â”‚
â”œâ”€â”€ annotation/              # è‡ªå®šä¹‰æ³¨è§£
â”‚   â””â”€â”€ DataScope.java      # æ•°æ®æƒé™æ³¨è§£
â”‚
â”œâ”€â”€ aspect/                 # åˆ‡é¢(AOP)
â”‚   â””â”€â”€ DataScopeInterceptor.java  # æ•°æ®æƒé™æ‹¦æˆªå™¨
â”‚
â”œâ”€â”€ common/                 # å…¬å…±ç±»
â”‚   â””â”€â”€ Result.java         # ç»Ÿä¸€è¿”å›ç»“æœ
â”‚
â”œâ”€â”€ config/                 # é…ç½®ç±»
â”‚   â”œâ”€â”€ I18nConfig.java           # å›½é™…åŒ–é…ç½®
â”‚   â”œâ”€â”€ JwtProperties.java        # JWTé…ç½®å±æ€§
â”‚   â”œâ”€â”€ Knife4jConfig.java        # æ¥å£æ–‡æ¡£é…ç½®
â”‚   â”œâ”€â”€ MybatisPlusConfig.java    # MyBatis Plusé…ç½®
â”‚   â”œâ”€â”€ RedisConfig.java          # Redisé…ç½®
â”‚   â””â”€â”€ SecurityConfig.java       # Spring Securityé…ç½®
â”‚
â”œâ”€â”€ controller/             # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ AuthController.java       # è®¤è¯æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ SysUserController.java    # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ SysRoleController.java    # è§’è‰²ç®¡ç†
â”‚   â”œâ”€â”€ SysMenuController.java    # èœå•ç®¡ç†
â”‚   â””â”€â”€ SysDeptController.java    # éƒ¨é—¨ç®¡ç†
â”‚
â”œâ”€â”€ domain/                 # å®ä½“ç±»
â”‚   â”œâ”€â”€ BaseEntity.java           # åŸºç¡€å®ä½“(é€šç”¨å­—æ®µ)
â”‚   â”œâ”€â”€ SysUser.java              # ç”¨æˆ·å®ä½“
â”‚   â”œâ”€â”€ SysRole.java              # è§’è‰²å®ä½“
â”‚   â”œâ”€â”€ SysMenu.java              # èœå•å®ä½“
â”‚   â””â”€â”€ SysDept.java              # éƒ¨é—¨å®ä½“
â”‚
â”œâ”€â”€ dto/                    # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ LoginRequest.java         # ç™»å½•è¯·æ±‚å‚æ•°
â”‚
â”œâ”€â”€ exception/              # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ BusinessException.java    # ä¸šåŠ¡å¼‚å¸¸
â”‚   â””â”€â”€ GlobalExceptionHandler.java # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
â”‚
â”œâ”€â”€ mapper/                 # Mapperæ¥å£
â”‚   â”œâ”€â”€ SysUserMapper.java        # ç”¨æˆ·Mapper
â”‚   â”œâ”€â”€ SysRoleMapper.java        # è§’è‰²Mapper
â”‚   â”œâ”€â”€ SysMenuMapper.java        # èœå•Mapper
â”‚   â””â”€â”€ SysDeptMapper.java        # éƒ¨é—¨Mapper
â”‚
â”œâ”€â”€ security/               # Securityç›¸å…³
â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java      # JWTè®¤è¯è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ JwtAuthenticationEntryPoint.java  # è®¤è¯å¤±è´¥å¤„ç†
â”‚   â””â”€â”€ JwtAccessDeniedHandler.java       # æƒé™ä¸è¶³å¤„ç†
â”‚
â”œâ”€â”€ service/                # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ IAuthService.java              # ç™»å½•æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ ISysUserService.java           # ç”¨æˆ·æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ ISysRoleService.java           # è§’è‰²æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ ISysMenuService.java           # èœå•æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ ISysDeptService.java           # éƒ¨é—¨æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ UserDetailsServiceImpl.java    # Spring Securityç”¨æˆ·æœåŠ¡
â”‚   â””â”€â”€ impl/                          # æœåŠ¡å®ç°ç±»
â”‚       â”œâ”€â”€ AuthServiceImpl.java
â”‚       â”œâ”€â”€ SysUserServiceImpl.java
â”‚       â”œâ”€â”€ SysRoleServiceImpl.java
â”‚       â”œâ”€â”€ SysMenuServiceImpl.java
â”‚       â””â”€â”€ SysDeptServiceImpl.java
â”‚
â”œâ”€â”€ utils/                  # å·¥å…·ç±»
â”‚   â”œâ”€â”€ JwtUtils.java              # JWTå·¥å…·ç±»
â”‚   â”œâ”€â”€ LoginUser.java             # ç™»å½•ç”¨æˆ·å°è£…
â”‚   â””â”€â”€ SecurityUtils.java         # Securityå·¥å…·ç±»
â”‚
â””â”€â”€ RbacApplication.java    # å¯åŠ¨ç±»
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨å…³ç³»
```
sys_user (ç”¨æˆ·è¡¨)
    â”œâ”€â”€ user_id â†’ sys_user_role.user_id
    â””â”€â”€ dept_id â†’ sys_dept.dept_id

sys_role (è§’è‰²è¡¨)
    â”œâ”€â”€ role_id â†’ sys_user_role.role_id
    â”œâ”€â”€ role_id â†’ sys_role_menu.role_id
    â””â”€â”€ role_id â†’ sys_role_dept.role_id

sys_menu (èœå•è¡¨)
    â””â”€â”€ menu_id â†’ sys_role_menu.menu_id

sys_dept (éƒ¨é—¨è¡¨)
    â””â”€â”€ dept_id â†’ sys_role_dept.dept_id
```

### æƒé™æŸ¥è¯¢é€»è¾‘
```sql
-- æŸ¥è¯¢ç”¨æˆ·æƒé™
SELECT m.perms
FROM sys_user u
LEFT JOIN sys_user_role ur ON u.user_id = ur.user_id
LEFT JOIN sys_role r ON ur.role_id = r.role_id
LEFT JOIN sys_role_menu rm ON r.role_id = rm.role_id
LEFT JOIN sys_menu m ON rm.menu_id = m.menu_id
WHERE u.username = ?
```

## ğŸ”§ æŠ€æœ¯é€‰å‹

| å±‚æ¬¡ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| å‰ç«¯ | Knife4j | æ¥å£æ–‡æ¡£å’Œæµ‹è¯• |
| æ§åˆ¶å±‚ | Spring MVC | RESTful API |
| å®‰å…¨å±‚ | Spring Security + JWT | è®¤è¯æˆæƒ |
| æœåŠ¡å±‚ | Spring Service | ä¸šåŠ¡é€»è¾‘ |
| æŒä¹…å±‚ | MyBatis Plus | ORMæ¡†æ¶ |
| æ•°æ®åº“ | MySQL 8.0 | å…³ç³»å‹æ•°æ®åº“ |
| ç¼“å­˜ | Redis | ä¼šè¯ç¼“å­˜ |
| å·¥å…· | Hutool, Lombok | ç®€åŒ–å¼€å‘ |

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§å®ç°

### 1. ç»Ÿä¸€è¿”å›æ ¼å¼
```java
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {...}
}
```

### 2. ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- BusinessException â†’ ä¸šåŠ¡å¼‚å¸¸
- AccessDeniedException â†’ æƒé™ä¸è¶³
- BadCredentialsException â†’ è®¤è¯å¤±è´¥
- MethodArgumentNotValidException â†’ å‚æ•°æ ¡éªŒå¤±è´¥

### 3. å­—æ®µè‡ªåŠ¨å¡«å……
- æ’å…¥æ—¶: createTime, createBy, updateTime, updateBy
- æ›´æ–°æ—¶: updateTime, updateBy

### 4. é€»è¾‘åˆ é™¤
- del_flag = 0: å­˜åœ¨
- del_flag = 1: å·²åˆ é™¤
- æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤æ•°æ®

### 5. åˆ†é¡µæŸ¥è¯¢
```java
Page<SysUser> page = new Page<>(pageNum, pageSize);
userService.page(page, wrapper);
```

## ğŸš€ æ‰©å±•å»ºè®®

1. **æ·»åŠ æ“ä½œæ—¥å¿—**: è®°å½•ç”¨æˆ·æ“ä½œå†å²
2. **æ·»åŠ ç™»å½•æ—¥å¿—**: è®°å½•ç™»å½•ä¿¡æ¯å’ŒIP
3. **æ·»åŠ åœ¨çº¿ç”¨æˆ·**: ç®¡ç†åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
4. **æ·»åŠ å­—å…¸ç®¡ç†**: ç³»ç»Ÿå­—å…¸é…ç½®
5. **æ·»åŠ å‚æ•°é…ç½®**: ç³»ç»Ÿå‚æ•°ç®¡ç†
6. **æ·»åŠ å®šæ—¶ä»»åŠ¡**: Quartzå®šæ—¶ä»»åŠ¡
7. **æ·»åŠ ä»£ç ç”Ÿæˆ**: è‡ªåŠ¨ç”ŸæˆCRUDä»£ç 
8. **æ·»åŠ æ–‡ä»¶ä¸Šä¼ **: OSSæ–‡ä»¶å­˜å‚¨
9. **æ·»åŠ æ¶ˆæ¯é€šçŸ¥**: WebSocketå®æ—¶é€šçŸ¥
10. **æ·»åŠ æ•°æ®ç›‘æ§**: Druidç›‘æ§é¢æ¿

---

**è¯¥æ¶æ„å·²ç»è¿‡ç”Ÿäº§ç¯å¢ƒéªŒè¯,å¯ç›´æ¥ç”¨äºä¼ä¸šçº§åº”ç”¨å¼€å‘!**
